#!/bin/bash
# Send payment on Stellar with optional memo
# Usage: pay <SENDER> <RECIPIENT> <AMOUNT> [--asset CODE:ISSUER] [--memo TEXT] [--memo-id ID]
# Output: JSON with transaction result

set -e

if [ $# -lt 3 ]; then
    echo "Usage: pay <SENDER> <RECIPIENT> <AMOUNT> [--asset CODE:ISSUER] [--memo TEXT] [--memo-id ID]" >&2
    exit 1
fi

SENDER="$1"
RECIPIENT="$2"
AMOUNT_XLM="$3"
shift 3

ASSET="native"
MEMO_TYPE=""
MEMO_VALUE=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --asset) ASSET="$2"; shift 2 ;;
        --memo) MEMO_TYPE="text"; MEMO_VALUE="$2"; shift 2 ;;
        --memo-id) MEMO_TYPE="id"; MEMO_VALUE="$2"; shift 2 ;;
        *) echo "Unknown parameter: $1" >&2; exit 1 ;;
    esac
done

# Convert to stroops
STROOPS=$(python3 -c "
amount = float('$AMOUNT_XLM')
if amount <= 0: raise ValueError
print(int(amount * 10_000_000))
" 2>/dev/null) || {
    echo '{"success": false, "error": {"code": "invalid_amount", "message": "Invalid amount: '"$AMOUNT_XLM"'"}}'
    exit 1
}

# Resolve addresses for output
if [[ "$SENDER" != G* ]]; then
    SENDER_ADDR=$(stellar keys address "$SENDER" 2>/dev/null) || SENDER_ADDR="$SENDER"
else
    SENDER_ADDR="$SENDER"
fi
if [[ "$RECIPIENT" != G* ]]; then
    RECIPIENT_ADDR=$(stellar keys address "$RECIPIENT" 2>/dev/null) || RECIPIENT_ADDR="$RECIPIENT"
else
    RECIPIENT_ADDR="$RECIPIENT"
fi

ASSET_DISPLAY="$ASSET"
[ "$ASSET" = "native" ] && ASSET_DISPLAY="XLM"

# Step 1: Build XDR
BUILD_ARGS=(stellar tx new payment \
    --source "$SENDER" \
    --destination "$RECIPIENT" \
    --asset "$ASSET" \
    --amount "$STROOPS" \
    --network testnet \
    --build-only)

XDR=$("${BUILD_ARGS[@]}" 2>/dev/null) || {
    echo "{\"success\": false, \"error\": {\"code\": \"build_failed\", \"message\": \"Failed to build payment transaction\"}}"
    exit 1
}

# Step 2: If memo, decode XDR -> inject memo -> re-encode
if [ -n "$MEMO_TYPE" ]; then
    if [ "$MEMO_TYPE" = "text" ]; then
        MEMO_JSON="{\"text\": \"$MEMO_VALUE\"}"
    elif [ "$MEMO_TYPE" = "id" ]; then
        MEMO_JSON="{\"id\": $MEMO_VALUE}"
    fi
    XDR=$(echo "$XDR" | stellar tx decode 2>/dev/null | python3 -c "
import sys, json
tx = json.load(sys.stdin)
tx['tx']['tx']['memo'] = $MEMO_JSON
json.dump(tx, sys.stdout)
" | stellar tx encode 2>/dev/null) || {
        echo "{\"success\": false, \"error\": {\"code\": \"memo_failed\", \"message\": \"Failed to set memo\"}}"
        exit 1
    }
fi

# Step 3: Sign
SIGNED=$(echo "$XDR" | stellar tx sign --sign-with-key "$SENDER" --network testnet 2>/dev/null) || {
    echo "{\"success\": false, \"error\": {\"code\": \"sign_failed\", \"message\": \"Failed to sign transaction\"}}"
    exit 1
}

# Step 4: Send
RESULT=$(stellar tx send --network testnet "$SIGNED" 2>/dev/null) || {
    echo "{\"success\": false, \"error\": {\"code\": \"send_failed\", \"message\": \"Failed to send transaction\"}}"
    exit 1
}

# Build output JSON
OUTPUT="{\"success\": true, \"from\": \"$SENDER_ADDR\", \"to\": \"$RECIPIENT_ADDR\", \"amount\": \"$AMOUNT_XLM\", \"asset\": \"$ASSET_DISPLAY\", \"stroops\": $STROOPS"
if [ -n "$MEMO_TYPE" ]; then
    OUTPUT="$OUTPUT, \"memo_type\": \"$MEMO_TYPE\", \"memo\": \"$MEMO_VALUE\""
fi
OUTPUT="$OUTPUT}"

echo "$OUTPUT"
